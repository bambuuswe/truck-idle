<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Idle Truck Tycoon Ultimate üöõ</title>

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
  color: white;
  min-height: 100vh;
  overflow-x: hidden;
}

h1 {
  text-align: center;
  margin: 10px 0;
  text-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
  font-size: 1.8em;
  background: linear-gradient(90deg, #22c55e, #3b82f6, #22c55e);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.money {
  text-align: center;
  font-size: 1.3em;
  background: rgba(31, 41, 55, 0.9);
  padding: 15px;
  margin: 10px;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(34, 197, 94, 0.3);
  backdrop-filter: blur(10px);
  position: sticky;
  top: 10px;
  z-index: 100;
}

.container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 10px;
  max-width: 800px;
  margin: 0 auto;
  padding-bottom: 100px;
}

.card {
  background: rgba(31, 41, 55, 0.8);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(75, 85, 99, 0.5);
  backdrop-filter: blur(10px);
  transition: transform 0.2s;
}

.card:hover {
  transform: translateY(-2px);
}

button {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
}

button:hover:not(:disabled) {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(34, 197, 94, 0.5);
}

button:disabled {
  background: linear-gradient(135deg, #374151, #1f2937);
  cursor: not-allowed;
  opacity: 0.5;
  box-shadow: none;
}

.buy-btn {
  background: linear-gradient(135deg, #22c55e, #16a34a);
}

.upgrade-btn {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  font-size: 0.9em;
  padding: 10px;
  margin-top: 8px;
}

.route-btn {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  font-size: 0.85em;
  padding: 8px 12px;
  margin: 4px;
  width: auto;
  display: inline-block;
}

.route-btn.active {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
}

select {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  background: #111827;
  color: white;
  border: 2px solid #374151;
  font-size: 1em;
}

/* MAP STYLES - FIXAD MED B√ÑTTRE KOORDINATER */
#map-container {
  position: relative;
  height: 600px; /* H√∂gre f√∂r mer utrymme */
  border-radius: 16px;
  background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 50%, #1e1b4b 100%);
  overflow: hidden;
  border: 2px solid rgba(59, 130, 246, 0.5);
  box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
}

.road-network {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.road {
  stroke: #4b5563;
  stroke-width: 3;
  fill: none;
  opacity: 0.6;
}

.road.active {
  stroke: #22c55e;
  stroke-width: 4;
  opacity: 1;
  filter: drop-shadow(0 0 5px rgba(34, 197, 94, 0.5));
}

.city {
  position: absolute;
  font-size: 0.85em;
  background: rgba(17, 24, 39, 0.95);
  padding: 12px 16px;
  border-radius: 12px;
  cursor: pointer;
  border: 2px solid #4b5563;
  transition: all 0.3s;
  z-index: 10;
  text-align: center;
  min-width: 100px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  /* VIKTIGT: Anv√§nd transform f√∂r centrerad positionering */
  transform: translate(-50%, -50%);
}

.city:hover {
  transform: translate(-50%, -50%) scale(1.1);
  border-color: #22c55e;
  z-index: 20;
}

.city.active {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border-color: #16a34a;
  box-shadow: 0 0 20px rgba(34, 197, 94, 0.6);
}

.city.locked {
  opacity: 0.7;
  cursor: not-allowed;
  background: #374151;
  border-color: #6b7280;
}

.city small {
  display: block;
  font-size: 0.75em;
  opacity: 0.9;
  margin-top: 3px;
}

/* TRUCKS ON MAP */
.truck-entity {
  position: absolute;
  font-size: 28px;
  z-index: 20;
  cursor: pointer;
  filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.5));
  transition: transform 0.1s;
  pointer-events: auto;
  transform: translate(-50%, -50%);
}

.truck-entity:hover {
  transform: translate(-50%, -50%) scale(1.3);
  z-index: 30;
}

.truck-tooltip {
  position: absolute;
  background: rgba(0, 0, 0, 0.9);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 0.75em;
  pointer-events: none;
  z-index: 40;
  border: 1px solid #22c55e;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.2s;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  margin-bottom: 5px;
}

.truck-entity:hover .truck-tooltip {
  opacity: 1;
}

.truck-entity.moving {
  animation: bounce 0.5s infinite alternate;
}

@keyframes bounce {
  from { transform: translate(-50%, -50%) scale(1.3); }
  to { transform: translate(-50%, -70%) scale(1.3); }
}

/* TRUCK CARDS */
.truck-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 12px;
}

.truck-card {
  background: rgba(31, 41, 55, 0.6);
  border-radius: 12px;
  padding: 15px;
  border: 2px solid transparent;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.truck-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #22c55e, #3b82f6);
  opacity: 0;
  transition: opacity 0.3s;
}

.truck-card:hover::before {
  opacity: 1;
}

.truck-card.owned {
  border-color: rgba(34, 197, 94, 0.3);
}

.truck-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.truck-icon {
  font-size: 2em;
}

.truck-info h4 {
  margin: 0;
  font-size: 1.1em;
}

.truck-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  font-size: 0.85em;
  color: #9ca3af;
  margin: 10px 0;
}

.price-tag {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: rgba(34, 197, 94, 0.2);
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.9em;
  font-weight: 600;
  color: #22c55e;
}

.route-selector {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #374151;
}

.route-label {
  font-size: 0.8em;
  color: #9ca3af;
  margin-bottom: 5px;
}

/* PROGRESS & STATS */
.progress-bar {
  width: 100%;
  height: 8px;
  background: #374151;
  border-radius: 4px;
  overflow: hidden;
  margin-top: 10px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #22c55e, #3b82f6);
  width: 0%;
  transition: width 0.5s;
  box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  font-size: 0.9em;
}

.stat-item {
  background: rgba(17, 24, 39, 0.6);
  padding: 10px;
  border-radius: 8px;
  text-align: center;
}

.stat-value {
  font-size: 1.3em;
  font-weight: 700;
  color: #22c55e;
}

/* ACHIEVEMENTS */
.achievement {
  position: fixed;
  top: 20px;
  right: -400px;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  padding: 20px 25px;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
  transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  z-index: 1000;
  max-width: 350px;
  border: 2px solid rgba(255, 255, 255, 0.2);
}

.achievement.show {
  right: 20px;
}

.achievement h4 {
  margin: 0 0 5px 0;
  font-size: 1.2em;
}

/* MODAL */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(5px);
}

.modal.show {
  display: flex;
}

.modal-content {
  background: linear-gradient(135deg, #1f2937, #111827);
  padding: 30px;
  border-radius: 20px;
  max-width: 500px;
  width: 90%;
  border: 2px solid #22c55e;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

/* LOG */
.activity-log {
  max-height: 150px;
  overflow-y: auto;
  font-size: 0.8em;
  background: rgba(17, 24, 39, 0.6);
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
}

.log-entry {
  padding: 4px 0;
  border-bottom: 1px solid #374151;
  color: #9ca3af;
}

.log-entry:last-child {
  border-bottom: none;
}

/* ANIMATIONS */
@keyframes moneyPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.money-update {
  animation: moneyPulse 0.3s;
  color: #22c55e;
  text-shadow: 0 0 20px rgba(34, 197, 94, 0.8);
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.card {
  animation: slideIn 0.5s ease-out;
}

/* SCROLLBAR */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #1f2937;
}

::-webkit-scrollbar-thumb {
  background: #4b5563;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #6b7280;
}

/* RESPONSIVE */
@media (max-width: 600px) {
  #map-container {
    height: 500px;
  }
  
  .city {
    font-size: 0.75em;
    min-width: 80px;
    padding: 8px 10px;
  }
  
  .truck-grid {
    grid-template-columns: 1fr;
  }
}

/* TUTORIAL OVERLAY */
.tutorial-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(5px);
}

.tutorial-content {
  background: linear-gradient(135deg, #1f2937, #111827);
  padding: 30px;
  border-radius: 20px;
  max-width: 500px;
  width: 90%;
  border: 2px solid #22c55e;
  text-align: center;
}

.tutorial-content h2 {
  color: #22c55e;
  margin-bottom: 20px;
}

.tutorial-content ol {
  text-align: left;
  line-height: 1.8;
  margin: 20px 0;
}

.tutorial-content li {
  margin: 10px 0;
}
</style>
</head>

<body>

<h1>üöõ Idle Truck Tycoon Ultimate</h1>
<div class="money" id="moneyCard">
  üí∞ $<span id="money">100</span> | 
  üí∏ $<span id="income">0</span>/sek |
  ‚≠ê Niv√• <span id="level">1</span> |
  üåç <span id="cityName">Stockholm</span>
</div>

<div class="container">

<!-- MAP -->
<div class="card">
  <h3>üó∫Ô∏è Norden & Europa <span style="float:right;font-size:0.8em;color:#9ca3af">Klicka p√• stad f√∂r att flytta HQ</span></h3>
  <div id="map-container">
    <svg class="road-network" id="roadSvg"></svg>
    <!-- Cities will be generated by JS -->
  </div>
  
  <div style="margin-top:15px;display:flex;justify-content:space-between;align-items:center;">
    <div>
      <b>Aktiv rutt:</b> <span id="activeRoute" style="color:#22c55e">V√§lj nedan</span>
    </div>
    <div style="font-size:0.9em;color:#9ca3af">
      üöõ <span id="activeTrucks">0</span> lastbilar p√• v√§gen
    </div>
  </div>
  
  <div class="progress-bar">
    <div class="progress-fill" id="routeProgress"></div>
  </div>
  
  <div class="activity-log" id="activityLog">
    <div class="log-entry">üéÆ V√§lkommen! 1. V√§lj en rutt nedan 2. K√∂p en lastbil 3. Tj√§na pengar!</div>
  </div>
</div>

<!-- ROUTE SELECTOR -->
<div class="card">
  <h3>üõ£Ô∏è V√§lj Transportrutt <span style="color:#f59e0b">‚Üê V√ÑLJ F√ñRST!</span></h3>
  <p style="font-size:0.9em;color:#9ca3af;margin-bottom:15px;">
    Varje rutt har olika risk, tid och bel√∂ning. L√§ngre rutter = mer pengar men l√§ngre tid.
  </p>
  <div id="routeButtons"></div>
</div>

<!-- TRUCKS -->
<div class="card">
  <h3>üöö Fordonspark <span style="float:right;font-size:0.8em;color:#9ca3af">10 modeller</span></h3>
  <div class="truck-grid" id="truckGrid"></div>
</div>

<!-- STATS -->
<div class="card">
  <h3>üìä F√∂retagsstatistik</h3>
  <div class="stats-grid">
    <div class="stat-item">
      <div class="stat-value" id="totalTrucks">0</div>
      <div>Lastbilar</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="totalRoutes">0</div>
      <div>Avklarade resor</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="totalEarned">0</div>
      <div>Total vinst</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="playTime">0</div>
      <div>Minuter spelade</div>
    </div>
  </div>
</div>

<!-- MANAGER -->
<div class="card">
  <h3>üëî Chefer & Automatisering</h3>
  <p style="font-size:0.9em;color:#9ca3af;">
    Anst√§ll chefer f√∂r att automatisera ink√∂p och uppgraderingar.
  </p>
  <div id="managerSection"></div>
</div>

</div>

<!-- ACHIEVEMENT POPUP -->
<div class="achievement" id="achievement">
  <h4>üèÜ Achievement Uppl√•st!</h4>
  <div id="achievement-text"></div>
</div>

<!-- TRUCK DETAIL MODAL -->
<div class="modal" id="truckModal">
  <div class="modal-content">
    <h2 id="modalTitle">Lastbilsinfo</h2>
    <div id="modalContent"></div>
    <button onclick="closeModal()" style="margin-top:20px;">St√§ng</button>
  </div>
</div>

<script>
/* ==================== GAME DATA ==================== */
const game = {
  money: 100,
  totalEarned: 100,
  startTime: Date.now(),
  lastSave: Date.now(),
  level: 1,
  totalDeliveries: 0,
  currentCity: 'stockholm',
  selectedRoute: null,
  managers: {
    autoBuy: false,
    autoUpgrade: false,
    autoRoute: false
  }
};

// 12 St√§der med UPPDATERADE koordinater - mer spridda!
const cities = {
  // Nord - Sverige & Norge (√∂vre delen)
  oslo: { name: "Oslo", x: 25, y: 15, mult: 1.5, cost: 800, unlocked: false, country: "Norge", region: "nord" },
  stockholm: { name: "Stockholm", x: 50, y: 20, mult: 1, cost: 0, unlocked: true, country: "Sverige", region: "nord" },
  helsinki: { name: "Helsingfors", x: 75, y: 12, mult: 1.6, cost: 1200, unlocked: false, country: "Finland", region: "nord" },
  
  // V√§st - Sverige v√§stkust & UK
  gothenburg: { name: "G√∂teborg", x: 35, y: 35, mult: 1.4, cost: 600, unlocked: false, country: "Sverige", region: "vast" },
  amsterdam: { name: "Amsterdam", x: 20, y: 45, mult: 2.3, cost: 4000, unlocked: false, country: "Nederl√§nderna", region: "vast" },
  london: { name: "London", x: 10, y: 60, mult: 2.8, cost: 6000, unlocked: false, country: "Storbritannien", region: "vast" },
  
  // Syd - Sverige syd & Danmark
  malmo: { name: "Malm√∂", x: 45, y: 50, mult: 1.5, cost: 1000, unlocked: false, country: "Sverige", region: "syd" },
  copenhagen: { name: "K√∂penhamn", x: 42, y: 65, mult: 1.7, cost: 1500, unlocked: false, country: "Danmark", region: "syd" },
  hamburg: { name: "Hamburg", x: 35, y: 75, mult: 2.0, cost: 2500, unlocked: false, country: "Tyskland", region: "centrum" },
  
  // Centrum - Tyskland
  berlin: { name: "Berlin", x: 55, y: 70, mult: 2.2, cost: 3500, unlocked: false, country: "Tyskland", region: "centrum" },
  
  // Sydv√§st - Frankrike
  paris: { name: "Paris", x: 18, y: 85, mult: 2.5, cost: 5000, unlocked: false, country: "Frankrike", region: "vast" },
  
  // √ñst - Polen
  warsaw: { name: "Warszawa", x: 85, y: 55, mult: 2.1, cost: 4500, unlocked: false, country: "Polen", region: "ost" }
};

// 10 Lastbilsmodeller
const trucks = {
  volvo_fl: {
    name: "Volvo FL",
    icon: "üöê",
    base: 2,
    cost: 100,
    efficiency: 1,
    upgradeCost: 250,
    upgradeLevel: 1,
    count: 0,
    speed: 80,
    capacity: 12,
    tier: 1,
    description: "Liten distributionsbil perfekt f√∂r stadsk√∂rning"
  },
  volvo_fm: {
    name: "Volvo FM",
    icon: "üöö",
    base: 8,
    cost: 450,
    efficiency: 1,
    upgradeCost: 800,
    upgradeLevel: 1,
    count: 0,
    speed: 85,
    capacity: 18,
    tier: 1,
    description: "M√•ngsidig lastbil f√∂r regionala transporter"
  },
  volvo_fh: {
    name: "Volvo FH",
    icon: "üöõ",
    base: 20,
    cost: 1200,
    efficiency: 1,
    upgradeCost: 2000,
    upgradeLevel: 1,
    count: 0,
    speed: 90,
    capacity: 24,
    tier: 2,
    description: "Sveriges stolthet - l√•ngdistans i v√§rldsklass"
  },
  scania_p: {
    name: "Scania P-serie",
    icon: "üöö",
    base: 12,
    cost: 650,
    efficiency: 1,
    upgradeCost: 1200,
    upgradeLevel: 1,
    count: 0,
    speed: 82,
    capacity: 16,
    tier: 2,
    description: "Flexibel byggd f√∂r alla typer av uppdrag"
  },
  scania_r: {
    name: "Scania R 730",
    icon: "üöõ",
    base: 35,
    cost: 2800,
    efficiency: 1,
    upgradeCost: 5000,
    upgradeLevel: 1,
    count: 0,
    speed: 95,
    capacity: 28,
    tier: 3,
    description: "V8-kraft f√∂r tung transport"
  },
  scania_s: {
    name: "Scania S 770",
    icon: "üöõ",
    base: 55,
    cost: 5500,
    efficiency: 1,
    upgradeCost: 9000,
    upgradeLevel: 1,
    count: 0,
    speed: 98,
    capacity: 32,
    tier: 4,
    description: "V√§rldens starkaste lastbilsserie"
  },
  man_tgx: {
    name: "MAN TGX",
    icon: "üöõ",
    base: 28,
    cost: 2200,
    efficiency: 1,
    upgradeCost: 4000,
    upgradeLevel: 1,
    count: 0,
    speed: 92,
    capacity: 26,
    tier: 3,
    description: "Tysk precision och effektivitet"
  },
  mercedes_actros: {
    name: "Mercedes Actros",
    icon: "üöõ",
    base: 45,
    cost: 4800,
    efficiency: 1,
    upgradeCost: 8000,
    upgradeLevel: 1,
    count: 0,
    speed: 94,
    capacity: 30,
    tier: 4,
    description: "Premium komfort med avancerad teknik"
  },
  daf_xg: {
    name: "DAF XG+",
    icon: "üöõ",
    base: 65,
    cost: 7500,
    efficiency: 1,
    upgradeCost: 12000,
    upgradeLevel: 1,
    count: 0,
    speed: 96,
    capacity: 34,
    tier: 4,
    description: "Holl√§ndsk innovation med maximal hyttkomfort"
  },
  tesla_semi: {
    name: "Tesla Semi",
    icon: "‚ö°",
    base: 120,
    cost: 15000,
    efficiency: 1.5,
    upgradeCost: 25000,
    upgradeLevel: 1,
    count: 0,
    speed: 100,
    capacity: 36,
    tier: 5,
    description: "Framtiden √§r h√§r - eldrift med raketfart",
    electric: true
  }
};

const routes = [
  { id: 'local', name: "Lokal distribution", mult: 1, time: 10, risk: 0, desc: "Korta transporter inom staden - s√§kra och snabba" },
  { id: 'regional', name: "Regional", mult: 1.8, time: 30, risk: 0.05, desc: "Till grannst√§der - bra balans mellan risk och bel√∂ning" },
  { id: 'national', name: "Rikst√§ckande", mult: 2.5, time: 60, risk: 0.10, desc: "Korsa hela landet - h√∂gre inkomst men l√§ngre tid" },
  { id: 'international', name: "Internationellt", mult: 4, time: 120, risk: 0.20, desc: "Till utlandet - stor risk, stor bel√∂ning" },
  { id: 'express', name: "Express", mult: 3, time: 45, risk: 0.15, desc: "Snabba leveranser med premium betalning" }
];

let activeTrucks = [];
let truckIdCounter = 0;

/* ==================== INIT ==================== */
function init() {
  loadGame();
  calculateOfflineIncome();
  renderMap();
  renderTrucks();
  renderRoutes();
  renderManagers();
  updateUI();
  startGameLoop();
  startAnimationLoop();
  startManagerLoop();
}

/* ==================== OFFLINE INCOME ==================== */
function calculateOfflineIncome() {
  const now = Date.now();
  const offlineSeconds = Math.floor((now - game.lastSave) / 1000);
  const maxOffline = 7200;
  
  if (offlineSeconds > 10 && totalTrucks() > 0) {
    const effectiveTime = Math.min(offlineSeconds, maxOffline);
    const offlineIncome = Math.floor(income() * effectiveTime * 0.5);
    
    if (offlineIncome > 0) {
      game.money += offlineIncome;
      game.totalEarned += offlineIncome;
      addLog(`üí§ Offline: Tj√§nade $${formatMoney(offlineIncome)} p√• ${Math.floor(effectiveTime/60)} minuter`);
    }
  }
}

function income() {
  let total = 0;
  for (let t in trucks) {
    const truck = trucks[t];
    total += truck.count * truck.base * truck.efficiency;
  }
  return Math.floor(total);
}

function totalTrucks() {
  return Object.values(trucks).reduce((a, b) => a + b.count, 0);
}

/* ==================== MAP & CITIES ==================== */
function renderMap() {
  const container = document.getElementById('map-container');
  const svg = document.getElementById('roadSvg');
  
  // Rita v√§gar mellan n√§rliggande st√§der
  svg.innerHTML = '';
  const connections = [
    ['stockholm', 'oslo'], ['stockholm', 'helsinki'], ['stockholm', 'gothenburg'],
    ['gothenburg', 'oslo'], ['gothenburg', 'malmo'], ['malmo', 'copenhagen'],
    ['copenhagen', 'hamburg'], ['hamburg', 'berlin'], ['hamburg', 'amsterdam'],
    ['amsterdam', 'london'], ['amsterdam', 'paris'], ['berlin', 'warsaw'],
    ['berlin', 'paris'], ['stockholm', 'helsinki']
  ];
  
  connections.forEach(([c1, c2]) => {
    if (cities[c1].unlocked && cities[c2].unlocked) {
      const city1 = cities[c1];
      const city2 = cities[c2];
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', city1.x + '%');
      line.setAttribute('y1', city1.y + '%');
      line.setAttribute('x2', city2.x + '%');
      line.setAttribute('y2', city2.y + '%');
      line.setAttribute('class', 'road');
      line.id = `road-${c1}-${c2}`;
      svg.appendChild(line);
    }
  });
  
  // Rita st√§der - ta bort gamla f√∂rst
  document.querySelectorAll('.city').forEach(c => c.remove());
  
  for (let key in cities) {
    const c = cities[key];
    const div = document.createElement('div');
    div.className = `city ${c.unlocked ? '' : 'locked'} ${key === game.currentCity ? 'active' : ''}`;
    div.style.left = c.x + '%';
    div.style.top = c.y + '%';
    // VIKTIGT: Ingen transform h√§r, den s√§tts i CSS!
    div.onclick = () => selectCity(key);
    div.id = `city-${key}`;
    
    const icon = c.unlocked ? (key === game.currentCity ? 'üè¢' : 'üèôÔ∏è') : 'üîí';
    div.innerHTML = `
      ${icon} ${c.name}<br>
      <small>${c.unlocked ? (c.mult + 'x inkomst') : ('$' + formatMoney(c.cost))}</small>
    `;
    
    container.appendChild(div);
  }
}

function selectCity(cityKey) {
  const c = cities[cityKey];
  
  if (!c.unlocked) {
    if (game.money >= c.cost) {
      game.money -= c.cost;
      c.unlocked = true;
      addLog(`üîì ${c.name} uppl√•st! Ny marknad tillg√§nglig.`);
      showAchievement(`${c.name} Uppl√•st!`);
      renderMap();
    } else {
      addLog(`‚ùå F√∂r fattig f√∂r ${c.name} (beh√∂ver $${formatMoney(c.cost)})`);
      return;
    }
  } else {
    game.currentCity = cityKey;
    addLog(`üè¢ Flyttade HQ till ${c.name} (${c.mult}x inkomstmultiplikator)`);
    renderMap();
  }
  
  updateUI();
  saveGame();
}

/* ==================== ROUTES ==================== */
function renderRoutes() {
  const container = document.getElementById('routeButtons');
  container.innerHTML = '';
  
  routes.forEach(route => {
    const btn = document.createElement('button');
    btn.className = `route-btn ${game.selectedRoute === route.id ? 'active' : ''}`;
    btn.innerHTML = `
      <div style="font-weight:bold">${route.name}</div>
      <div style="font-size:0.8em;opacity:0.9">
        ${route.mult}x | ${route.time}s | ${(route.risk*100)}% risk
      </div>
    `;
    btn.title = route.desc;
    btn.onclick = () => selectRoute(route.id);
    container.appendChild(btn);
  });
}

function selectRoute(routeId) {
  game.selectedRoute = routeId;
  renderRoutes();
  addLog(`üõ£Ô∏è V√§xlade till ${routes.find(r => r.id === routeId).name}`);
  
  // Om vi redan har lastbilar, skicka ut dem automatiskt p√• den nya rutten!
  if (totalTrucks() > 0) {
    Object.keys(trucks).forEach(type => {
      if (trucks[type].count > 0) {
        // Skicka ut alla befintliga lastbilar p√• den nya rutten
        for (let i = 0; i < trucks[type].count; i++) {
          setTimeout(() => sendTruckOnRoute(type), i * 500); // Sprid ut dem lite
        }
      }
    });
    addLog(`üöõ Skickade ut ${totalTrucks()} lastbilar p√• ${routes.find(r => r.id === routeId).name}!`);
  }
  
  updateUI();
}

/* ==================== TRUCKS ==================== */
function renderTrucks() {
  const grid = document.getElementById('truckGrid');
  grid.innerHTML = '';
  
  for (let key in trucks) {
    const t = trucks[key];
    const div = document.createElement('div');
    div.className = `truck-card ${t.count > 0 ? 'owned' : ''}`;
    
    const income = Math.floor(t.base * t.efficiency);
    
    div.innerHTML = `
      <div class="truck-header">
        <div class="truck-icon">${t.icon}</div>
        <div class="truck-info">
          <h4>${t.name}</h4>
          <div style="font-size:0.8em;color:#9ca3af">${t.description}</div>
        </div>
      </div>
      
      <div class="truck-stats">
        <span>üíµ $${income}/sek</span>
        <span>‚ö° ${Math.floor(t.efficiency*100)}% eff.</span>
        <span>üöõ √Ñgda: ${t.count}</span>
        <span>üí® ${t.speed} km/h</span>
      </div>
      
      <div style="display:flex;gap:10px;align-items:center;margin:10px 0;">
        <span class="price-tag">üí∞ $${formatMoney(t.cost)}</span>
        <span style="font-size:0.8em;color:#9ca3af">Niv√• ${t.upgradeLevel}</span>
      </div>
      
      <button class="buy-btn" onclick="buyTruck('${key}')" id="btn-${key}">
        K√∂p ${t.name}
      </button>
      
      ${t.count > 0 ? `
        <button class="upgrade-btn" onclick="upgradeTruck('${key}')" id="upg-${key}">
          üîß Uppgradera ($${formatMoney(t.upgradeCost)})<br>
          <small>+25% effektivitet</small>
        </button>
      ` : ''}
    `;
    
    grid.appendChild(div);
  }
}

function buyTruck(type) {
  const t = trucks[type];
  if (game.money >= t.cost) {
    game.money -= t.cost;
    t.count++;
    t.cost = Math.floor(t.cost * 1.5);
    
    addLog(`üöõ K√∂pte ${t.name} f√∂r $${formatMoney(Math.floor(t.cost/1.5))}`);
    
    // VIKTIGT: Skicka automatiskt ut p√• rutt om en √§r vald!
    if (game.selectedRoute) {
      sendTruckOnRoute(type);
      addLog(`üöÄ ${t.name} skickad ut p√• ${routes.find(r => r.id === game.selectedRoute).name}!`);
    } else {
      addLog(`‚ö†Ô∏è V√§lj en rutt f√∂rst f√∂r att skicka ut lastbilen!`);
    }
    
    checkAchievements();
    renderTrucks();
    updateUI();
    saveGame();
    
    document.getElementById('moneyCard').classList.add('money-update');
    setTimeout(() => document.getElementById('moneyCard').classList.remove('money-update'), 300);
  }
}

function upgradeTruck(type) {
  const t = trucks[type];
  if (game.money >= t.upgradeCost) {
    game.money -= t.upgradeCost;
    t.efficiency += 0.25;
    t.upgradeLevel++;
    t.upgradeCost = Math.floor(t.upgradeCost * 1.5);
    
    addLog(`üîß ${t.name} uppgraderad till niv√• ${t.upgradeLevel}!`);
    showAchievement(`${t.name} - Niv√• ${t.upgradeLevel}!`);
    
    renderTrucks();
    updateUI();
    saveGame();
  }
}

/* ==================== TRUCK MOVEMENT ==================== */
function sendTruckOnRoute(truckType) {
  if (!game.selectedRoute) return;
  
  const route = routes.find(r => r.id === game.selectedRoute);
  const truck = trucks[truckType];
  
  const possibleTargets = Object.keys(cities).filter(c => c !== game.currentCity && cities[c].unlocked);
  if (possibleTargets.length === 0) return;
  
  const target = possibleTargets[Math.floor(Math.random() * possibleTargets.length)];
  const targetCity = cities[target];
  
  const truckId = ++truckIdCounter;
  const travelTime = route.time * 1000;
  
  const truckEntity = {
    id: truckId,
    type: truckType,
    from: game.currentCity,
    to: target,
    startTime: Date.now(),
    duration: travelTime,
    earnings: Math.floor(truck.base * route.mult * targetCity.mult * truck.efficiency),
    completed: false
  };
  
  activeTrucks.push(truckEntity);
  
  renderTruckOnMap(truckEntity);
}

function renderTruckOnMap(truckEntity) {
  const container = document.getElementById('map-container');
  const fromCity = cities[truckEntity.from];
  const toCity = cities[truckEntity.to];
  const truck = trucks[truckEntity.type];
  
  const div = document.createElement('div');
  div.className = 'truck-entity';
  div.id = `truck-${truckEntity.id}`;
  div.innerHTML = `
    ${truck.icon}
    <div class="truck-tooltip">
      <b>${truck.name}</b><br>
      Till: ${toCity.name}<br>
      Vinst: $${truckEntity.earnings}<br>
      ${truck.electric ? '‚ö° Elbil' : 'üõ¢Ô∏è Diesel'}
    </div>
  `;
  
  div.style.left = fromCity.x + '%';
  div.style.top = fromCity.y + '%';
  div.onclick = () => showTruckDetails(truckEntity);
  
  container.appendChild(div);
  
  setTimeout(() => {
    div.style.transition = `all ${truckEntity.duration}ms linear`;
    div.style.left = toCity.x + '%';
    div.style.top = toCity.y + '%';
    div.classList.add('moving');
  }, 50);
  
  highlightRoad(truckEntity.from, truckEntity.to);
}

function highlightRoad(from, to) {
  const roadId = `road-${from}-${to}`;
  const roadId2 = `road-${to}-${from}`;
  const road = document.getElementById(roadId) || document.getElementById(roadId2);
  if (road) {
    road.classList.add('active');
    setTimeout(() => road.classList.remove('active'), 5000);
  }
}

function showTruckDetails(entity) {
  const modal = document.getElementById('truckModal');
  const truck = trucks[entity.type];
  const toCity = cities[entity.to];
  
  document.getElementById('modalTitle').innerHTML = `${truck.icon} ${truck.name}`;
  document.getElementById('modalContent').innerHTML = `
    <div style="display:grid;gap:15px;">
      <div style="background:rgba(34,197,94,0.1);padding:15px;border-radius:12px;">
        <h4 style="margin:0 0 10px 0;color:#22c55e">Aktuell transport</h4>
        <p>üéØ Destination: <b>${toCity.name}</b></p>
        <p>üí∞ F√∂rv√§ntad vinst: <b>$${entity.earnings}</b></p>
        <p>‚è±Ô∏è Restid: <b>${Math.floor(entity.duration/1000)} sekunder</b></p>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div class="stat-item">
          <div class="stat-value">${truck.speed}</div>
          <div>km/h</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${truck.capacity}</div>
          <div>ton</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${truck.tier}</div>
          <div>Klass</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${Math.floor(truck.efficiency*100)}%</div>
          <div>Effektivitet</div>
        </div>
      </div>
      
      <p style="color:#9ca3af;font-size:0.9em;">${truck.description}</p>
    </div>
  `;
  
  modal.classList.add('show');
}

function closeModal() {
  document.getElementById('truckModal').classList.remove('show');
}

/* ==================== MANAGERS ==================== */
function renderManagers() {
  const section = document.getElementById('managerSection');
  const managers = [
    { id: 'autoBuy', name: 'Automatisk Ink√∂pare', cost: 5000, desc: 'K√∂per nya lastbilar automatiskt n√§r du har r√•d' },
    { id: 'autoUpgrade', name: 'Verkstadschef', cost: 15000, desc: 'Uppgraderar lastbilar automatiskt' },
    { id: 'autoRoute', name: 'Logistikchef', cost: 30000, desc: 'Skickar lastbilar p√• rutter automatiskt' }
  ];
  
  section.innerHTML = managers.map(m => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(17,24,39,0.6);border-radius:8px;margin-bottom:8px;">
      <div>
        <b>${m.name}</b><br>
        <small style="color:#9ca3af">${m.desc}</small>
      </div>
      <button onclick="hireManager('${m.id}', ${m.cost})" ${game.money < m.cost || game.managers[m.id] ? 'disabled' : ''} 
              style="width:auto;padding:8px 16px;font-size:0.9em;">
        ${game.managers[m.id] ? '‚úÖ Anst√§lld' : `$${formatMoney(m.cost)}`}
      </button>
    </div>
  `).join('');
}

function hireManager(id, cost) {
  if (game.money >= cost && !game.managers[id]) {
    game.money -= cost;
    game.managers[id] = true;
    addLog(`üëî Anst√§llde ${id === 'autoBuy' ? 'Automatisk Ink√∂pare' : id === 'autoUpgrade' ? 'Verkstadschef' : 'Logistikchef'}!`);
    showAchievement('Ny chef anst√§lld!');
    renderManagers();
    updateUI();
    saveGame();
  }
}

function startManagerLoop() {
  setInterval(() => {
    if (game.managers.autoBuy) {
      const affordable = Object.entries(trucks)
        .filter(([k, t]) => game.money >= t.cost)
        .sort((a, b) => a[1].cost - b[1].cost)[0];
      if (affordable) buyTruck(affordable[0]);
    }
    
    if (game.managers.autoUpgrade) {
      const upgradable = Object.entries(trucks)
        .filter(([k, t]) => t.count > 0 && game.money >= t.upgradeCost)
        .sort((a, b) => b[1].count - a[1].count)[0];
      if (upgradable) upgradeTruck(upgradable[0]);
    }
    
    if (game.managers.autoRoute && game.selectedRoute) {
      Object.keys(trucks).forEach(type => {
        if (trucks[type].count > 0 && Math.random() < 0.3) {
          sendTruckOnRoute(type);
        }
      });
    }
  }, 2000);
}

/* ==================== GAME LOOP ==================== */
function startGameLoop() {
  setInterval(() => {
    // Inkomst fr√•n station√§ra lastbilar (de som inte √§r p√• rutt)
    const baseIncome = income();
    const cityMult = cities[game.currentCity].mult;
    const earned = Math.floor(baseIncome * cityMult * 0.1);
    
    game.money += earned;
    game.totalEarned += earned;
    
    const now = Date.now();
    activeTrucks = activeTrucks.filter(t => {
      if (!t.completed && now > t.startTime + t.duration) {
        game.money += t.earnings;
        game.totalEarned += t.earnings;
        game.totalDeliveries++;
        
        const el = document.getElementById(`truck-${t.id}`);
        if (el) {
          el.style.transform = 'translate(-50%, -50%) scale(0)';
          setTimeout(() => el.remove(), 300);
        }
        
        addLog(`‚úÖ Leverans klar! +$${t.earnings} fr√•n ${cities[t.to].name}`);
        
        const route = routes.find(r => r.id === game.selectedRoute);
        if (route && Math.random() < route.risk) {
          const penalty = Math.floor(t.earnings * 0.2);
          game.money -= penalty;
          addLog(`üö® Problem p√• v√§gen! Reparationskostnad: $${penalty}`);
        }
        
        t.completed = true;
        return false;
      }
      return true;
    });
    
    const newLevel = Math.floor(Math.log(game.totalEarned / 1000 + 1) / Math.log(1.5)) + 1;
    if (newLevel > game.level) {
      game.level = newLevel;
      showAchievement(`Niv√• ${newLevel}! B√§ttre aff√§rer v√§ntar.`);
    }
    
    checkAchievements();
    updateUI();
    saveGame();
  }, 1000);
}

function startAnimationLoop() {
  setInterval(() => {
    const now = Date.now();
    let totalProgress = 0;
    
    activeTrucks.forEach(t => {
      const progress = Math.min((now - t.startTime) / t.duration, 1);
      totalProgress += progress;
    });
    
    const avgProgress = activeTrucks.length > 0 ? totalProgress / activeTrucks.length : 0;
    document.getElementById('routeProgress').style.width = (avgProgress * 100) + '%';
    document.getElementById('activeTrucks').textContent = activeTrucks.length;
  }, 100);
}

/* ==================== UTILITY ==================== */
function formatMoney(num) {
  if (num >= 1000000) return (num/1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num/1000).toFixed(1) + 'k';
  return num.toString();
}

function addLog(text) {
  const log = document.getElementById('activityLog');
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.textContent = `[${new Date().toLocaleTimeString('sv-SE', {hour: '2-digit', minute:'2-digit', second:'2-digit'})}] ${text}`;
  log.insertBefore(entry, log.firstChild);
  
  while (log.children.length > 20) {
    log.removeChild(log.lastChild);
  }
}

/* ==================== ACHIEVEMENTS ==================== */
const achievements = [
  { id: 'first_truck', name: 'F√∂rsta investeringen', check: () => totalTrucks() >= 1 },
  { id: 'fleet_10', name: 'V√§xande flotta', check: () => totalTrucks() >= 10 },
  { id: 'fleet_50', name: 'Transportimperium', check: () => totalTrucks() >= 50 },
  { id: 'rich_10k', name: 'Tiotusenkronorsklubben', check: () => game.money >= 10000 },
  { id: 'rich_100k', name: 'Miljon√§r', check: () => game.money >= 100000 },
  { id: 'globetrotter', name: 'Europeer', check: () => game.currentCity === 'berlin' || game.currentCity === 'paris' },
  { id: 'electric', name: 'Gr√∂n framtid', check: () => trucks.tesla_semi.count > 0 },
  { id: 'delivery_100', name: 'P√•litlig leverant√∂r', check: () => game.totalDeliveries >= 100 },
  { id: 'upgrade_20', name: 'Perfektionist', check: () => Object.values(trucks).reduce((a, t) => a + t.upgradeLevel, 0) >= 20 }
];

function checkAchievements() {
  achievements.forEach(a => {
    if (!a.shown && a.check()) {
      a.shown = true;
      showAchievement(a.name);
    }
  });
}

function showAchievement(text) {
  const el = document.getElementById('achievement');
  document.getElementById('achievement-text').textContent = text;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 4000);
}

/* ==================== SAVE/LOAD ==================== */
function saveGame() {
  game.lastSave = Date.now();
  localStorage.setItem('truckTycoonUltimate', JSON.stringify({ game, trucks, cities, achievements }));
}

function loadGame() {
  const saved = localStorage.getItem('truckTycoonUltimate');
  if (saved) {
    const data = JSON.parse(saved);
    Object.assign(game, data.game);
    Object.assign(trucks, data.trucks);
    Object.assign(cities, data.cities);
    if (data.achievements) {
      data.achievements.forEach(a => {
        const existing = achievements.find(ea => ea.id === a.id);
        if (existing) existing.shown = a.shown;
      });
    }
  }
}

/* ==================== UI UPDATES ==================== */
function updateUI() {
  document.getElementById('money').textContent = formatMoney(Math.floor(game.money));
  document.getElementById('income').textContent = formatMoney(income());
  document.getElementById('level').textContent = game.level;
  document.getElementById('cityName').textContent = cities[game.currentCity].name;
  
  const route = routes.find(r => r.id === game.selectedRoute);
  document.getElementById('activeRoute').textContent = route ? route.name : 'V√§lj rutt';
  
  document.getElementById('totalTrucks').textContent = totalTrucks();
  document.getElementById('totalRoutes').textContent = game.totalDeliveries;
  document.getElementById('totalEarned').textContent = formatMoney(Math.floor(game.totalEarned));
  document.getElementById('playTime').textContent = Math.floor((Date.now() - game.startTime) / 60000);
  
  for (let key in trucks) {
    const btn = document.getElementById(`btn-${key}`);
    const upgBtn = document.getElementById(`upg-${key}`);
    if (btn) btn.disabled = game.money < trucks[key].cost;
    if (upgBtn) upgBtn.disabled = game.money < trucks[key].upgradeCost;
  }
}

/* ==================== START ==================== */
init();
</script>

</body>
</html>
